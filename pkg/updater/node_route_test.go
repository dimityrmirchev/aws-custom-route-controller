// SPDX-FileCopyrightText: 2022 SAP SE or an SAP affiliate company and Gardener contributors
//
// SPDX-License-Identifier: Apache-2.0

package updater_test

import (
	"github.com/gardener/aws-custom-route-controller/pkg/updater"
	. "github.com/onsi/ginkgo/v2"
	. "github.com/onsi/gomega"
	corev1 "k8s.io/api/core/v1"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
)

var _ = Describe("NamedNodeRoutes", func() {
	var (
		podCIDRs1       = []string{"10.0.1.0/24"}
		node1InstanceID = "i-0001"
		node1           = &corev1.Node{
			ObjectMeta: metav1.ObjectMeta{
				Name: "node1",
			},
			Spec: corev1.NodeSpec{
				PodCIDRs:   podCIDRs1,
				ProviderID: makeProviderID(node1InstanceID),
			},
		}
		podCIDRs2       = []string{"10.0.7.0/24"}
		node2InstanceID = "i-0001"
		node2           = &corev1.Node{
			ObjectMeta: metav1.ObjectMeta{
				Name: "node2",
			},
			Spec: corev1.NodeSpec{
				PodCIDRs:   podCIDRs2,
				ProviderID: makeProviderID(node2InstanceID),
			},
		}
		podCIDRs3 = []string{"10.0.33.0/24"}
		node3     = &corev1.Node{
			ObjectMeta: metav1.ObjectMeta{
				Name: "node3",
			},
			Spec: corev1.NodeSpec{
				PodCIDRs: podCIDRs3,
			},
		}
	)

	It("should extract node data", func() {
		routes := updater.NewNamedNodeRoutes()
		route1, changed1 := routes.AddNodeRoute(node1)
		Expect(route1).To(Equal(updater.NewNodeRoute(node1InstanceID, podCIDRs1[0])))
		Expect(changed1).To(BeTrue())
		route1b, changed1b := routes.AddNodeRoute(node1)
		Expect(route1b).NotTo(BeNil())
		Expect(changed1b).To(BeFalse())

		route2, changed2 := routes.AddNodeRoute(node2)
		Expect(route2).To(Equal(updater.NewNodeRoute(node2InstanceID, podCIDRs2[0])))
		Expect(changed2).To(BeTrue())

		route3, changed3 := routes.AddNodeRoute(node3)
		Expect(route3).To(BeNil())
		Expect(changed3).To(BeFalse())

		routes1 := routes.GetRoutesIfChanged()
		Expect(len(routes1)).To(Equal(2))
		routes1b := routes.GetRoutesIfChanged()
		Expect(routes1b).To(BeNil())

		route1c, changed1c := routes.AddNodeRoute(node1)
		Expect(route1c).NotTo(BeNil())
		Expect(changed1c).To(BeFalse())

		changed3b := routes.RemoveNodeRoute(node3.Name)
		Expect(changed3b).To(BeNil())
		changed2b := routes.RemoveNodeRoute(node2.Name)
		Expect(changed2b).NotTo(BeNil())
		changed2c := routes.RemoveNodeRoute(node2.Name)
		Expect(changed2c).To(BeNil())

		routes2 := routes.GetRoutesIfChanged()
		Expect(len(routes2)).To(Equal(1))
	})
})

func makeProviderID(instanceID string) string {
	return "aws:///eu-west-1a/" + instanceID
}
